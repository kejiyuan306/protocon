# 接口文档

版本号：0x0002

本套接口基于 protocon 协议，它规定了终端设备与 ies-con-connector 后端之间所有可用的命令类型。
主要是终端设备向后端定时上传设备当前状态、后端要求修改终端设备的运行状态等命令。

本文档将会对于每个命令，描述其 Type 与 Data 字段。对于 Data 字段的描述即为 Data 中 JSON 对象中出现的键值对类型。视命令的执行成功与否，键值对将会不同。

**注意**：本文中的客户端均为终端设备或网关设备，服务端为 ies-con-connector 平台。

## JSON 对象命名规范

JSON 对象中的 Key 使用下划线命名法。

## 命令一览

### 统一错误响应

#### Error Code

这里列出所有的错误码类型

| Value | Description                        |
| ----- | ---------------------------------- |
| 0x01  | 注册失败，设备待审核               |
| 0x02  | 重复注册                           |
| 0x03  | 设备在厂家黑名单中                 |
| 0x04  | 设备的型号在厂家黑名单中           |
| 0x05  | 客户端标识符对应的设备不存在       |
| 0x06  | 网关标识符与客户端标识符不匹配     |
| 0x07  | 服务端套接字地址与预留网址不符     |
| 0x08  | 客户端套接字地址与平台预留网址不符 |
| 0x09  | 运行数据字段未定义                 |
| 0x0A  | 请求的 Data 不规范，解释失败       |
| 0x0B  | 平台下发的控制指令执行失败         |

#### Data 

如果`被动方`在执行命令时产生了错误，无法返回正常的响应，它应当将响应中的 Status 字段设为对应的错误码，且响应中的 Data 中的键值对应当仅返回错误信息，具体见下表。

| Key     | Value Type | Required | Description                      |
| ------- | ---------- | -------- | -------------------------------- |
| details | string     |          | 错误详细信息，用于测试或日志输出 |

### 命令示例

这里展示一个简单的 Hello World 命令，包括请求与响应的格式以及。
该命令仅作为示范，实际不存在。

#### Hello World

向另一方发送自己的姓名与年龄，另一方应当返回 Hello World 消息。

##### 命令类型

0x0001

##### 请求 Data 格式

Required 列表示该键值对是否必要，打星号为必要，否则为不必要。

| Key  | Value Type | Required | Description |
| ---- | ---------- | -------- | ----------- |
| name | string     | *        | 姓名        |
| age  | int        |          | 年龄        |

##### 响应 Data 格式

| Key     | Value Type | Required | Description           |
| ------- | ---------- | -------- | --------------------- |
| message | string     | *        | 一条 Hello World 消息 |

##### 响应错误码

| Value | Description      |
| ----- | ---------------- |
| 0x01  | 年龄超过人类极限 |

#### Hello World 命令完整执行流程

`主动方`发送一条如下请求。

```json
{
    "name": "San Zhang",
    "age": 22
}
```

TODO: 展示使用 protocon 协议编码的 HEX 码

`被动方`接收到该请求后，如果命令执行成功返回则响应中的 Data 如下：

```json
{
    "message": "Hello World, name: `San Zhang`, age: `22`"
}
```

TODO: 展示使用 protocon 协议编码的 HEX 码

如果失败，例如请求中的年龄为500岁，则错误码为 0x01，Data 如下：

```json
{
    "details": "Your age `500` is too large"
}
```

TODO: 展示使用 protocon 协议编码的 HEX 码

### 公共供接口

公共的命令，双端都可以发起。

#### 心跳

在双端一段时间内没有发起命令时，必须发送心跳命令以确认连接状态。
如果心跳命令发起后`被动方`没有在规定时间回复响应，则视为连接断开。

除了测试连接状态，心跳命令还可用于验证设备的客户端标识符是否正确，也可用于测试网络环境。

##### 命令类型

0x0004

##### 请求 Data 格式

| Key | Value Type | Required | Description |
| --- | ---------- | -------- | ----------- |
| lic | string     |          | 设备公钥    |

##### 响应 Data 格式

| Key | Value Type | Required | Description    |
| --- | ---------- | -------- | -------------- |
| msg | string     |          | 警告信息       |
| ts  | long       |          | 收到请求的时间 |

### 客户端供接口

客户端提供的接口，即命令由服务端发起，请求（Request）由服务端发送，操作由客户端完成，响应（Response）由客户端返回。

### 服务端供接口

服务端提供的接口，即客户端发送请求（Request），服务端返回响应（Response）。

#### 直连设备注册

完成设备和平台的首次对接，终端请求获取平台的客户端ID。

一个测点当作一个设备。
设备接入注册前，业主方可事先先在平台预录设备信息，并在平台提交设备信息（设备厂家名称、设备型号设备序列号及设备功能描述）至平台管理员审核，平台管理员预授权设备接入权限，否则，设备发送注册请求后，平台记录设备信息，需待管理员后台审核通过后才能完成注册流程。

##### 命令类型

0x0002

##### 请求 Data 格式

| Key  | Value Type | Required | Description            |
| ---- | ---------- | -------- | ---------------------- |
| corp | string     |          | 设备厂家名称           |
| name | string     |          | 设备名称               |
| type | string     | *        | 设备型号               |
| sn   | string     | *        | 设备序列号，由厂家生成 |
| lic  | string     |          | 设备公钥               |

##### 响应 Data 格式

| Key       | Value Type | Required | Description            |
| --------- | ---------- | -------- | ---------------------- |
| client_id | int        | *        | 平台生成的客户端标识符 |

#### 非直连设备注册

对于网关类终端，在完成网关注册后，网关下属接入的设备也需注册成功后才能正常使用。

##### 命令类型

0x0003

##### 请求 Data 格式

| Key   | Value Type | Required | Description            |
| ----- | ---------- | -------- | ---------------------- |
| gw_id | int        | *        | 网关设备的客户端标识符 |
| corp  | string     |          | 设备厂家名称           |
| name  | string     |          | 设备名称               |
| type  | string     | *        | 设备型号               |
| sn    | string     | *        | 设备序列号，由厂家生成 |

##### 响应 Data 格式

| Key       | Value Type | Required | Description            |
| --------- | ---------- | -------- | ---------------------- |
| client_id | int        | *        | 平台生成的客户端标识符 |
